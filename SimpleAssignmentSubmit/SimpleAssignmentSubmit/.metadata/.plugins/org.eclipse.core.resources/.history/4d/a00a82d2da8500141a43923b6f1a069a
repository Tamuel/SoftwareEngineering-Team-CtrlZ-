package ServerClientConsole;
/* This file contains material supporting section 3.7 of the textbook:
 "Object Oriented Software Engineering" and is issued under the open-source
 license found at www.lloseng.com */ 

import java.io.*;

import Client.*;
import common.*;

/**
 * This class constructs the UI for a chat client.  It implements the
 * chat interface in order to activate the display() method.
 * Warning: Some of the code here is cloned in ServerConsole
 * 
 * �� Class �� Display() 硫�����瑜� �댁�⑺���� 梨��� UI瑜� ��怨듯����.
 * 二쇱��: �ш린���� 紐�紐� 肄����ㅼ�� ServerConsole �� Clone �쇰� ����.
 * 
 * @author Fran&ccedil;ois B&eacute;langer
 * @author Dr Timothy C. Lethbridge  
 * @author Dr Robert Lagani&egrave;re
 * @version July 2000
 */
public class ServerConsole implements ChatIF // ChatIF �명�고���댁�� �몄�
{
  //Class variables *************************************************
  
  /**
   * The default port to connect on.
   * DEFAULT_PORT : �ы�� 踰���, �� 踰��몃� 而ㅻ�ν��
   */
  final public static int DEFAULT_PORT = 9000;
  
  //Instance variables **********************************************
  
  /**
   * The instance of the client that created this ConsoleChat.
   * ChatClient 媛�泥� ����
   */
  EchoServer server;

  
  //Constructors ****************************************************

  /**
   * Constructs an instance of the ClientConsole UI.
   *
   * ClientConsole UI 媛�泥�(�몄�ㅽ�댁��) ����
   *
   * @param host The host to connect to.
   * @param port The port to connect on.
   */
  public ServerConsole(int port) // Server Console ���깆��
  {
	  server = new EchoServer(port, this);
		try 
		{
			server.listen(); //Start listening for connections
		} 
		catch (Exception ex) 
		{
			System.out.println("ERROR - Could not listen for clients! port : " + port);
		}
  }

  
  //Instance methods ************************************************
  
  /**
   * This method waits for input from the console.  Once it is 
   * received, it sends it to the client's message handler.
   * 
   * �� 硫������� console 李쎌�� ���ν�� ��源�吏� ��湲고����. 
   * console 李쎌������ ���� client�� message handler濡� 蹂대�몃��.
   */
  public void accept() 
  {
    try
    {
      BufferedReader fromConsole = 
        new BufferedReader(new InputStreamReader(System.in));
      String message;
      
      while (true) // 臾댄�� 諛�蹂듯��硫댁�� console ���μ�� 諛����ㅼ��.
      {
        message = fromConsole.readLine();
       
        if(!message.startsWith("#"))
        {
        	server.sendToAllClients(message);
        }
        else
        {
        	if(message.equals("#quit"))
        	{
        		server.close();
        		System.exit(0);
        	}
        	else if(message.equals("#stop"))
        	{
        		server.stopListening();
        	}
        	else if(message.equals("#close"))
        	{
        		server.close();
        	}
        	else if(message.length() >= 8 && message.substring(0, 8).equals("#setport"))
        	{	
        		if(server.isListening())
        		{
        			System.err.println("��踰�瑜� 硫�異� 二쇱�� 諛�������.");
        		}
        		else if(message.contains("<") && message.contains(">"))
        		{
        			server.setPort(Integer.parseInt(
        				message.substring(message.indexOf('<') + 1, message.indexOf('>'))));
        		}
        		else System.out.println("�몄��瑜� �ｌ�� 二쇱��湲� 諛�������.");
        	}
        	else if(message.equals("#start"))
        	{
        		if(server.isListening())
        		{
        			System.err.println("��踰�媛� 媛���以�������.");
        		}
        		else server.listen();
        	}
        	else if(message.equals("#getport"))
        	{
        		System.out.println(server.getPort());
        	}
          
         }
        
      }
    } 
    catch (Exception ex) 
    {
      System.out.println
        ("Unexpected error while reading from console!");
    }
  }

  /**
   * This method overrides the method in the ChatIF interface.  It
   * displays a message onto the screen.
   * 
   * Display()�� ���듯���� 硫��몄�瑜� 異���
   * 
   * @param message The string to be displayed.
   */
  
  public void display(String message) 
  {
	  System.out.println("SERVER MSG> " + message);
  }

  
  //Class methods ***************************************************
  
  /**
   * This method is responsible for the creation of the Client UI.
   * 
   * 
   * 
   * @param args[0] The host to connect to.
   */
  public static void main(String[] args) 
  {
    int port = 0; //Port to listen on

    try
    {
      port = Integer.parseInt(args[0]); //Get port from command line
    }
    catch(Throwable t)
    {
      port = DEFAULT_PORT; //Set port to 5555
    }
	
    ServerConsole sv = new ServerConsole(port);
    sv.accept();
  }
}
//End of ConsoleChat class
